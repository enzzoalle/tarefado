{% extends 'app/base.html' %}
{% block content %}
<div class="container mt-3">
  <h4 class="mb-3">Meus Prompts</h4>

  <div class="card mb-4 shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>Novo Prompt</span>
      <button class="btn btn-sm btn-outline-primary" id="toggleFormBtn">Mostrar/Ocultar</button>
    </div>
    <div class="card-body" id="formWrapper">
      <form method="post">
        {% csrf_token %}
        <div class="mb-2">
          {{ form.titulo.label_tag }} {{ form.titulo }}
        </div>
        <div class="mb-2">
          <label for="templateSelect" class="form-label">Template rápido (opcional)</label>
          {{ form.template_key }}
        </div>
        <div class="mb-2">
          {{ form.conteudo.label_tag }} {{ form.conteudo }}
        </div>
        <button class="btn btn-success btn-sm">Salvar</button>
      </form>

      <div class="mt-3">
        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="collapse" data-bs-target="#templateLista">
          Ver conteúdo dos templates
        </button>
        <div class="collapse mt-2" id="templateLista">
          <div class="list-group small" id="templateButtons"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3">
    {% for p in prompts %}
    <div class="col-12 col-md-6 col-lg-4">
      <div class="card h-100 shadow-sm">
        <div class="card-body d-flex flex-column">
          <h6 class="text-primary mb-2">{{ p.titulo }}</h6>
            {% if p.template_key %}
              <span class="badge bg-info mb-2">{{ p.get_template_key_display }}</span>
            {% endif %}
          <pre class="small flex-grow-1" style="white-space: pre-wrap;">{{ p.conteudo|truncatechars:400 }}</pre>
          <div class="d-flex gap-2 mt-2">
            <a href="{% url 'prompt_edit' p.pk %}" class="btn btn-sm btn-outline-primary">Editar</a>
            <form method="post" action="{% url 'prompt_delete' p.pk %}" onsubmit="return confirm('Confirmar exclusão?');">
              {% csrf_token %}
              <button class="btn btn-sm btn-outline-danger">Excluir</button>
            </form>
            <button class="btn btn-sm btn-outline-secondary copy-btn" data-text="{{ p.conteudo|escapejs }}">Copiar</button>
          </div>
        </div>
      </div>
    </div>
    {% empty %}
      <p>Nenhum prompt cadastrado.</p>
    {% endfor %}
  </div>
</div>

<script>
const templates = {
  conceito: "Me explica isso como se você estivesse estudando junto comigo para aprender de verdade. Divide o conceito em partes...",
  projeto: "Finge que nós dois estamos desenvolvendo um projeto e temos que implementar isso. Me explica passo a passo...",
  revisao: "Atua como meu colega de estudos e me faz perguntas desafiadoras...",
  skill: "Imagina que somos dois estudantes querendo dominar essa linguagem...",
  profissional: "Finge que estamos nos preparando para trabalhar remotamente como devs juniors...",
  escrita: "Finge que somos estudantes escrevendo um trabalho acadêmico...",
  checklist: "Finge que somos dois alunos revisando se entendemos tudo...",
  simulacao: "Finge que somos devs remotos iniciando um projeto..."
};

document.addEventListener("DOMContentLoaded", () => {
  const select = document.getElementById("templateSelect");
  const conteudo = document.getElementById("id_conteudo");
  const listContainer = document.getElementById("templateButtons");
  const toggleBtn = document.getElementById("toggleFormBtn");
  const formWrapper = document.getElementById("formWrapper");

  toggleBtn.addEventListener("click", () => formWrapper.classList.toggle("d-none"));

  Object.entries(templates).forEach(([key, text]) => {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "list-group-item list-group-item-action";
    btn.textContent = key + " (inserir)";
    btn.addEventListener("click", () => {
      conteudo.value = text;
      [...select.options].forEach((o,i) => { if (o.value === key) select.selectedIndex = i; });
    });
    listContainer.appendChild(btn);
  });

  select.addEventListener("change", () => {
    const val = select.value;
    if (val && templates[val]) conteudo.value = templates[val];
  });

  document.querySelectorAll(".copy-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const text = btn.getAttribute("data-text");
      navigator.clipboard.writeText(text).then(()=>{
        btn.textContent = "Copiado";
        setTimeout(()=> btn.textContent = "Copiar", 1500);
      });
    });
  });
});
</script>
{% endblock content %}